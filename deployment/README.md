# Deployment

The deployment system makes use of
[Ansible](https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html).
A working system can be created by running one of the provided
[playbooks](https://docs.ansible.com/ansible/latest/user_guide/playbooks.html):

- `system.yml` - setup the base Linux environment
- `deploy.yml` - deploy the latest *master* to the server
- `site.yml` - run both playbooks in succession

The playbooks expect an inventory with several variables set:

	---
	bundle: "change-me-for-the-name-of-the-bundle"
	db_name: '{{bundle}}'
	db_user: '{{bundle}}'
	db_host: 'localhost'
	db_pass: 'asdfjklasdfjlk'
	bundle_domain: 'localhost'
	surfconext_site: 'test'
	lets_encrypt_directory_url: "https=>//acme-staging-v02.api.letsencrypt.org/directory"
	secret_key_base: 'somesupersecretstringwithalongenoughlength'
	surfconext_client_secret: 'test'
	google_sign_in_client_id: 'test'
	google_sign_in_client_secret: 'test'
	unsplash_app_name: 'Link'
	unsplash_access_key: 'test'
	sign_in_with_apple_client_id: "test.vagrant"
	sign_in_with_apple_team_id: "ABCD"
	sign_in_with_apple_private_key_id: "1234"
	sign_in_with_apple_private_key: |
	  -----BEGIN PRIVATE KEY-----
	  Blurb goes here
	  -----END PRIVATE KEY-----

All options need to be set to ensure that the application will work. The
`bundle` key needs to be set to one of the names from the `bundles` folder (for
instance `link`). The secret key base needs to set to a random string. This can
be generated by any means; for instance (on Linux):

	head -c32 </dev/urandom|xxd -p -u

SSL is automatically configured using [Let's
Encrypt](https://letsencrypt.org/). Remove `-staging` to get production
certificates. This requires `bundle_domain` to be the working domain
for this deployment. All other options should be self-explanatory.

The inventory with it's secrets should not be added to the repository. Usage of
[Ansible Vault](https://docs.ansible.com/ansible/latest/user_guide/vault.html)
is also advised to keep the secrets safe.

## Development

A [Vagrant](https://www.vagrantup.com) configuration is available to test the
playbooks on a virtual machine.

## Operations Info

The deployment scripts expect an Ubuntu 20.04 LTS installation as their base.
This base is configured with a several security measures like a firewall. The
application is deployed under a seperate user. A Systemd unit file is setup to
ensure automatic startup and restart in cases of crashes.

The application is configure through environment variables provided in the
Systemd unit file. A sudo line is added to allow the application user to
restart the application (`sudo systemctl restart link.service`).

All logging is managed by Systemd. Application logs can be inspected with (on
the server):

	journalctl -fu <bundle>

This will stream the logs. Run `man journalctl` for more info.

The applications are deployed to the home dir of the *bundle* user
(`/home/<bundle>`). The current release is set by the `current` symlink.
Current and older releases are available in the `releases` folder. The
deployment script automatically clears out older releases.
